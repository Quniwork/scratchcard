<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue 3 CDN 示例</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    #app {
      width: 100%;
      height: 100%;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: .5rem;
      padding: 20px;
      margin: 0 auto;
    }

    /* 手機直式樣式 */
    @media (orientation: portrait) {
      .grid-container {
        grid-template-columns: repeat(5, 1fr);
      }
    }
    @media (orientation: landscape) {
      .grid-container {
        grid-template-columns: repeat(10, 1fr);
      }
    }

    .grid-button {
      aspect-ratio: 1;
      border: none;
      background: transparent url('image/ic-lucky.png') center/cover no-repeat;
      cursor: pointer;
      font-size: calc(16px + 3vw);
      line-height: 1;
      font-weight: bold;
      font-family: 'Inter', sans-serif;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      &:disabled {
        background: #ccc;
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      position: relative;
    }

    .scratch-card {
      width: 200px;
      height: 200px;
    }

    .scratch-card-number span {
      font-family: 'Inter', sans-serif;
    }

    .close-button {
      width: 100%;
      height: 40px;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="grid-container">
      <button v-for="(num, index) in gridNumbers" 
              :key="index"
              class="grid-button"
              @click="openScratchCard(index)"
              :disabled="revealedNumbers[index] !== null">
        {{ revealedNumbers[index] !== null ? revealedNumbers[index] : '' }}
      </button>
    </div>

    <div v-if="showModal" class="modal">
      <div class="modal-content">
        <div class="scratch-card">
          <div class="scratch-card-cover-container">
            <canvas class="scratch-card-canvas" width="200" height="200"></canvas>
            <img class="scratch-card-canvas-render hidden" alt="">
            <div class="scratch-card-cover shine">
              <svg class="scratch-card-cover-background" viewBox="0 0 200 200">
                <path d="M 0,0 L 200,0 L 200,200 L 0,200 Z" />
              </svg>
            </div>
          </div>
          <div class="scratch-card-number">
            <canvas ref="numberCanvas" width="200" height="200"></canvas>
          </div>
        </div>

        <p class="scratch-card-text">🎁 刮出您的幸運數字!</p>
        <button class="close-button" @click="closeModal">關閉</button>
      </div>
    </div>

    <svg width="0" height="0">
      <filter id="remove-black" color-interpolation-filters="sRGB">
        <feColorMatrix type="matrix" values="1 0 0 0 0
                            0 1 0 0 0
                            0 0 1 0 0
                            -1 -1 -1 0 1" result="black-pixels" />
        <feComposite in="SourceGraphic" in2="black-pixels" operator="out" />
      </filter>
      <filter id="noise">
        <feTurbulence baseFrequency="0.5"></feTurbulence>
      </filter>
    </svg>
  </div>

  <script>
    const { createApp, ref } = Vue

    const app = createApp({
      setup() {
        const isSafari = ref(/^((?!chrome|android).)*safari/i.test(navigator.userAgent));
        let previousUrl = null;

        const showModal = ref(false);
        const currentIndex = ref(null);
        const currentNumber = ref(null);
        const gridNumbers = ref(Array(80).fill(null).map((_, i) => i + 1).sort(() => Math.random() - 0.5));
        const revealedNumbers = ref(Array(80).fill(null));
        const numberCanvas = ref(null);

        const scratchCardCover = ref(null);
        const scratchCardCanvasRender = ref(null);
        const scratchCardCoverContainer = ref(null);
        const scratchCardText = ref(null);
        const scratchCardImage = ref(null);
        const canvas = ref(null);
        const context = ref(null);
        let isPointerDown = false;
        let positionX;
        let positionY;
        let clearDetectionTimeout = null;

        const drawNumber = () => {
          const ctx = numberCanvas.value.getContext('2d');
          ctx.clearRect(0, 0, 200, 200);
          ctx.font = 'bold 72px Inter';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillStyle = '#000';
          ctx.fillText(currentNumber.value, 100, 100);
        };

        const openScratchCard = (index) => {
          currentIndex.value = index;
          currentNumber.value = gridNumbers.value[index];
          showModal.value = true;
          setTimeout(() => {
            initCanvas();
            drawNumber();
          }, 100);
        };

        const closeModal = () => {
          showModal.value = false;
          if(canvas.value) {
            context.value.clearRect(0, 0, canvas.value.width, canvas.value.height);
          }
          scratchCardCover.value?.classList.add('shine');
          scratchCardCoverContainer.value?.classList.remove('clear', 'hidden');
          scratchCardImage.value?.classList.remove('animate');
        };

        const initCanvas = () => {
          canvas.value = document.querySelector('canvas');
          context.value = canvas.value.getContext('2d');
          scratchCardCover.value = document.querySelector('.scratch-card-cover');
          scratchCardCanvasRender.value = document.querySelector('.scratch-card-canvas-render');
          scratchCardCoverContainer.value = document.querySelector('.scratch-card-cover-container');
          scratchCardText.value = document.querySelector('.scratch-card-text');
          scratchCardImage.value = document.querySelector('.scratch-card-number');
          numberCanvas.value = document.querySelector('.scratch-card-number canvas');

          const devicePixelRatio = window.devicePixelRatio || 1;
          const canvasWidth = canvas.value.offsetWidth * devicePixelRatio;
          const canvasHeight = canvas.value.offsetHeight * devicePixelRatio;

          canvas.value.width = canvasWidth;
          canvas.value.height = canvasHeight;

          context.value.scale(devicePixelRatio, devicePixelRatio);

          if (isSafari.value) {
            canvas.value.classList.add('hidden');
          }

          setupEventListeners();
        };

        const setupEventListeners = () => {
          canvas.value.addEventListener('pointerdown', handlePointerDown);
        };

        const handlePointerDown = (e) => {
          scratchCardCover.value.classList.remove('shine');
          ({ x: positionX, y: positionY } = getPosition(e));
          clearTimeout(clearDetectionTimeout);

          canvas.value.addEventListener('pointermove', plot);

          window.addEventListener('pointerup', (e) => {
            canvas.value.removeEventListener('pointermove', plot);
            clearDetectionTimeout = setTimeout(() => {
              checkBlackFillPercentage();
            }, 500);
          }, { once: true });
        };

        const checkBlackFillPercentage = () => {
          const imageData = context.value.getImageData(0, 0, canvas.value.width, canvas.value.height);
          const pixelData = imageData.data;

          let blackPixelCount = 0;

          for (let i = 0; i < pixelData.length; i += 4) {
            const red = pixelData[i];
            const green = pixelData[i + 1];
            const blue = pixelData[i + 2];
            const alpha = pixelData[i + 3];

            if (red === 0 && green === 0 && blue === 0 && alpha === 255) {
              blackPixelCount++;
            }
          }

          const blackFillPercentage = blackPixelCount * 100 / (canvas.value.width * canvas.value.height);

          if (blackFillPercentage >= 15) { // 降低觸發百分比到15%
            scratchCardCoverContainer.value.classList.add('clear');
            confetti({
              particleCount: 100,
              spread: 90,
              origin: {
                y: (scratchCardText.value.getBoundingClientRect().bottom + 60) / window.innerHeight,
              },
            });
            scratchCardText.value.textContent = '🎉 恭喜刮出 ' + currentNumber.value + ' !';
            scratchCardImage.value.classList.add('animate');
            scratchCardCoverContainer.value.addEventListener('transitionend', () => {
              scratchCardCoverContainer.value.classList.add('hidden');
              revealedNumbers.value[currentIndex.value] = currentNumber.value;
              // 移除事件監聽器,防止繼續刮
              canvas.value.removeEventListener('pointerdown', handlePointerDown);
              canvas.value.removeEventListener('pointermove', plot);
            }, { once: true });
          }
        };

        const getPosition = ({ clientX, clientY }) => {
          const { left, top } = canvas.value.getBoundingClientRect();
          return {
            x: clientX - left,
            y: clientY - top,
          };
        };

        const plotLine = (context, x1, y1, x2, y2) => {
          var diffX = Math.abs(x2 - x1);
          var diffY = Math.abs(y2 - y1);
          var dist = Math.sqrt(diffX * diffX + diffY * diffY);
          var step = dist / 50;
          var i = 0;
          var t;
          var x;
          var y;

          while (i < dist) {
            t = Math.min(1, i / dist);

            x = x1 + (x2 - x1) * t;
            y = y1 + (y2 - y1) * t;

            context.beginPath();
            context.arc(x, y, 16, 0, Math.PI * 2);
            context.fill();

            i += step;
          }
        };

        const setImageFromCanvas = () => {
          canvas.value.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            previousUrl = scratchCardCanvasRender.value.src;
            scratchCardCanvasRender.value.src = url;
            if (!previousUrl) {
              scratchCardCanvasRender.value.classList.remove('hidden');
            } else {
              URL.revokeObjectURL(previousUrl);
            }
            previousUrl = url;
          });
        };

        let setImageTimeout = null;

        const plot = (e) => {
          const { x, y } = getPosition(e);
          plotLine(context.value, positionX, positionY, x, y);
          positionX = x;
          positionY = y;
          if (isSafari.value) {
            clearTimeout(setImageTimeout);

            setImageTimeout = setTimeout(() => {
              setImageFromCanvas();
            }, 5);
          }
        };

        return {
          isSafari,
          showModal,
          currentNumber,
          gridNumbers,
          revealedNumbers,
          openScratchCard,
          closeModal,
          numberCanvas
        }
      }
    })

    app.mount('#app')
  </script>
</body>

</html>